'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import {
  Container,
  Box,
  Typography,
  Button,
  Card,
  CardContent,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Alert,
  Chip,
  Divider,
} from '@mui/material';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import AddIcon from '@mui/icons-material/Add';
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import AutoFixHighIcon from '@mui/icons-material/AutoFixHigh';
import PsychologyIcon from '@mui/icons-material/Psychology';
import PersonAddIcon from '@mui/icons-material/PersonAdd';
import { api } from '@/lib/api';
import type { Novel, Chapter, ChapterCreate } from '@/types';

export default function NovelDetailPage() {
  const router = useRouter();
  const params = useParams();
  const novelId = Number(params.id);

  const [novel, setNovel] = useState<Novel | null>(null);
  const [chapters, setChapters] = useState<Chapter[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  // 创建/编辑章节对话框
  const [openDialog, setOpenDialog] = useState(false);
  const [editingChapter, setEditingChapter] = useState<Chapter | null>(null);
  const [chapterForm, setChapterForm] = useState<ChapterCreate>({
    chapter_number: 1,
    title: '',
    content: '',
  });

  // AI生成状态
  const [aiGenerating, setAiGenerating] = useState(false);

  useEffect(() => {
    loadNovelAndChapters();
  }, [novelId]);

  const loadNovelAndChapters = async () => {
    try {
      const [novelData, chaptersData] = await Promise.all([
        api.getNovel(novelId),
        api.getChapters(novelId),
      ]);
      setNovel(novelData);
      setChapters(chaptersData.sort((a, b) => a.chapter_number - b.chapter_number));
    } catch (err) {
      setError(err instanceof Error ? err.message : '加载失败');
      setTimeout(() => router.push('/dashboard'), 2000);
    } finally {
      setLoading(false);
    }
  };

  const handleCreateChapter = () => {
    const nextChapterNumber = chapters.length > 0
      ? Math.max(...chapters.map(c => c.chapter_number)) + 1
      : 1;

    setChapterForm({
      chapter_number: nextChapterNumber,
      title: '',
      content: '',
    });
    setEditingChapter(null);
    setOpenDialog(true);
  };

  const handleEditChapter = (chapter: Chapter) => {
    setChapterForm({
      chapter_number: chapter.chapter_number,
      title: chapter.title,
      content: chapter.content,
    });
    setEditingChapter(chapter);
    setOpenDialog(true);
  };

  const handleSaveChapter = async () => {
    try {
      if (editingChapter) {
        // 更新章节
        await api.updateChapter(novelId, editingChapter.id, {
          title: chapterForm.title,
          content: chapterForm.content,
        });
      } else {
        // 创建新章节
        await api.createChapter(novelId, chapterForm);
      }
      setOpenDialog(false);
      await loadNovelAndChapters();
    } catch (err) {
      setError(err instanceof Error ? err.message : '保存失败');
    }
  };

  const handleDeleteChapter = async (chapterId: number) => {
    if (!confirm('确定要删除这个章节吗？')) return;

    try {
      await api.deleteChapter(novelId, chapterId);
      await loadNovelAndChapters();
    } catch (err) {
      setError(err instanceof Error ? err.message : '删除失败');
    }
  };

  if (loading) {
    return (
      <Container maxWidth="lg">
        <Box sx={{ mt: 4, textAlign: 'center' }}>
          <Typography>加载中...</Typography>
        </Box>
      </Container>
    );
  }

  if (!novel) {
    return null;
  }

  return (
    <Container maxWidth="lg">
      <Box sx={{ mt: 4, mb: 4 }}>
        {/* 头部导航 */}
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <Button
            startIcon={<ArrowBackIcon />}
            onClick={() => router.push('/dashboard')}
          >
            返回列表
          </Button>
        </Box>

        {error && (
          <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError('')}>
            {error}
          </Alert>
        )}

        {/* 小说信息卡片 */}
        <Card sx={{ mb: 3 }}>
          <CardContent>
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
              <Box>
                <Typography variant="h4" gutterBottom>
                  {novel.title}
                </Typography>
                {novel.genre && (
                  <Chip label={novel.genre} size="small" sx={{ mr: 1 }} />
                )}
                <Chip
                  label={`${chapters.length} 章节`}
                  size="small"
                  color="primary"
                  variant="outlined"
                />
              </Box>
            </Box>

            {novel.description && (
              <>
                <Divider sx={{ my: 2 }} />
                <Typography variant="subtitle2" color="text.secondary">
                  简介
                </Typography>
                <Typography variant="body1" sx={{ mt: 1 }}>
                  {novel.description}
                </Typography>
              </>
            )}

            {novel.worldview && (
              <>
                <Divider sx={{ my: 2 }} />
                <Typography variant="subtitle2" color="text.secondary">
                  世界观设定
                </Typography>
                <Typography variant="body1" sx={{ mt: 1 }}>
                  {novel.worldview}
                </Typography>
              </>
            )}
          </CardContent>
        </Card>

        {/* 章节列表 */}
        <Card>
          <CardContent>
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
              <Typography variant="h6">章节列表</Typography>
              <Button
                variant="contained"
                startIcon={<AddIcon />}
                onClick={handleCreateChapter}
              >
                新建章节
              </Button>
            </Box>

            {chapters.length === 0 ? (
              <Box sx={{ textAlign: 'center', py: 4 }}>
                <Typography variant="body2" color="text.secondary">
                  还没有创建任何章节
                </Typography>
              </Box>
            ) : (
              <List>
                {chapters.map((chapter, index) => (
                  <ListItem
                    key={chapter.id}
                    divider={index < chapters.length - 1}
                    sx={{
                      '&:hover': {
                        bgcolor: 'action.hover',
                      },
                    }}
                  >
                    <ListItemText
                      primary={
                        <Typography variant="body1">
                          第 {chapter.chapter_number} 章：{chapter.title}
                        </Typography>
                      }
                      secondary={`字数：${chapter.word_count}`}
                    />
                    <ListItemSecondaryAction>
                      <IconButton
                        edge="end"
                        onClick={() => handleEditChapter(chapter)}
                        sx={{ mr: 1 }}
                      >
                        <EditIcon />
                      </IconButton>
                      <IconButton
                        edge="end"
                        onClick={() => handleDeleteChapter(chapter.id)}
                      >
                        <DeleteIcon />
                      </IconButton>
                    </ListItemSecondaryAction>
                  </ListItem>
                ))}
              </List>
            )}
          </CardContent>
        </Card>
      </Box>

      {/* 创建/编辑章节对话框 */}
      <Dialog
        open={openDialog}
        onClose={() => setOpenDialog(false)}
        maxWidth="md"
        fullWidth
      >
        <DialogTitle>
          {editingChapter ? '编辑章节' : '新建章节'}
        </DialogTitle>
        <DialogContent>
          <TextField
            fullWidth
            label="章节号"
            type="number"
            value={chapterForm.chapter_number}
            onChange={(e) =>
              setChapterForm({ ...chapterForm, chapter_number: Number(e.target.value) })
            }
            margin="normal"
            required
            disabled={!!editingChapter}
          />
          <TextField
            fullWidth
            label="章节标题"
            value={chapterForm.title}
            onChange={(e) => setChapterForm({ ...chapterForm, title: e.target.value })}
            margin="normal"
            required
            autoFocus
          />
          <TextField
            fullWidth
            label="章节内容"
            value={chapterForm.content}
            onChange={(e) => setChapterForm({ ...chapterForm, content: e.target.value })}
            margin="normal"
            multiline
            rows={12}
            required
            helperText={`当前字数：${chapterForm.content.length}`}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenDialog(false)}>取消</Button>
          <Button
            onClick={handleSaveChapter}
            variant="contained"
            disabled={!chapterForm.title || !chapterForm.content}
          >
            {editingChapter ? '保存' : '创建'}
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
}
